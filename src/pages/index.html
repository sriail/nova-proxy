<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nova Proxy</title>
    <!-- Scramjet scripts -->
    <script src="/scram/scramjet.all.js"></script>
    <script src="/baremux/index.js"></script>
    <!-- Ultraviolet scripts -->
    <script src="/uv/uv.bundle.js"></script>
    <script src="/uv.config.js"></script>
    <style>
      :root {
        --nav-bar-height: 49px;
        --tab-bar-height: 36px;
        --bg-color: #ffffff;
        --bg-secondary: #f8f8f8;
        --text-color: #000000;
        --text-secondary: rgba(0, 0, 0, 0.7);
        --border-color: #e0e0e0;
        --border-light: #d0d0d0;
        --border-lighter: #f0f0f0;
        --hover-bg: #e8e8e8;
        --active-bg: #d8d8d8;
        --icon-color: #333333;
        --icon-secondary: #666666;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --shadow-dropdown: rgba(0, 0, 0, 0.15);
        --tab-bg: #e0e0e0;
        --tab-active-bg: #ffffff;
        --tab-hover-bg: #d0d0d0;
      }
      body.dark {
        --bg-color: #1b1b1b;
        --bg-secondary: #2a2a2a;
        --text-color: #ffffff;
        --text-secondary: rgba(255, 255, 255, 0.7);
        --border-color: #3a3a3a;
        --border-light: #4a4a4a;
        --border-lighter: #333333;
        --hover-bg: #3a3a3a;
        --active-bg: #4a4a4a;
        --icon-color: #ffffff;
        --icon-secondary: #aaaaaa;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --shadow-dropdown: rgba(0, 0, 0, 0.4);
        --tab-bg: #3a3a3a;
        --tab-active-bg: #1b1b1b;
        --tab-hover-bg: #4a4a4a;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: var(--bg-color);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        transition: background-color 0.3s, color 0.3s;
      }
      /* Tab Bar */
      .tab-bar {
        display: flex;
        align-items: flex-end;
        padding: 4px 8px 0 8px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        height: var(--tab-bar-height);
        overflow-x: auto;
        overflow-y: hidden;
        scrollbar-width: thin;
        scrollbar-color: var(--border-light) transparent;
        position: sticky;
        top: 0;
        z-index: 1001;
      }
      .tab-bar::-webkit-scrollbar {
        height: 4px;
      }
      .tab-bar::-webkit-scrollbar-track {
        background: transparent;
      }
      .tab-bar::-webkit-scrollbar-thumb {
        background: var(--border-light);
        border-radius: 2px;
      }
      .tabs-container {
        display: flex;
        align-items: flex-end;
        flex: 1;
        min-width: 0;
        gap: 2px;
      }
      .tab {
        display: flex;
        align-items: center;
        background: var(--tab-bg);
        border-radius: 6px 6px 0 0;
        border: 1px solid var(--border-color);
        border-bottom: none;
        padding: 6px 12px;
        min-width: 60px;
        max-width: 200px;
        height: 32px;
        cursor: pointer;
        transition: background 0.2s, min-width 0.2s, padding 0.2s;
        flex-shrink: 1;
        flex-grow: 0;
        user-select: none;
        overflow: hidden;
      }
      .tab:hover {
        background: var(--tab-hover-bg);
      }
      .tab.active {
        background: var(--tab-active-bg);
        position: relative;
        border-color: var(--border-light);
      }
      .tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: var(--tab-active-bg);
      }
      .tab.dragging {
        opacity: 0.5;
      }
      .tab-favicon {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
        margin-right: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .tab-favicon img {
        width: 16px;
        height: 16px;
        object-fit: contain;
      }
      .tab-favicon svg {
        width: 16px;
        height: 16px;
        stroke: var(--icon-color);
      }
      .tab-title {
        flex: 1;
        font-size: 12px;
        color: var(--text-color);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
      }
      .tab-close {
        width: 16px;
        height: 16px;
        margin-left: 6px;
        flex-shrink: 0;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        opacity: 0.6;
        transition: opacity 0.2s, background 0.2s;
      }
      .tab-close:hover {
        opacity: 1;
        background: var(--hover-bg);
      }
      .tab-close svg {
        width: 12px;
        height: 12px;
        stroke: var(--icon-color);
      }
      /* Tab size states */
      .tab.compact {
        min-width: 50px;
        max-width: 50px;
        padding: 6px 6px;
      }
      .tab.compact .tab-title {
        display: none;
      }
      .tab.compact .tab-favicon {
        margin-right: 4px;
      }
      .tab.compact .tab-close {
        margin-left: 2px;
      }
      .tab.medium {
        max-width: 120px;
      }
      .tab.medium .tab-title {
        display: none;
      }
      .tab-add-btn {
        width: 28px;
        height: 28px;
        margin-left: 4px;
        border-radius: 6px;
        background: transparent;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: background 0.2s;
      }
      .tab-add-btn:hover {
        background: var(--hover-bg);
      }
      .tab-add-btn svg {
        width: 16px;
        height: 16px;
        stroke: var(--icon-color);
      }
      /* Upper Navigation Bar */
      .upper-nav {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        gap: 0.5rem;
        position: sticky;
        top: var(--tab-bar-height);
        z-index: 1000;
      }
      .nav-left {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }
      .nav-btn {
        background: var(--bg-color);
        border: 1px solid var(--border-light);
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }
      .nav-btn:hover {
        background: var(--hover-bg);
      }
      .nav-btn:active {
        background: var(--active-bg);
      }
      .nav-btn svg {
        width: 16px;
        height: 16px;
        stroke: var(--icon-color);
      }
      .nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .nav-url-container {
        flex: 1;
        display: flex;
        align-items: center;
        background: var(--bg-color);
        border: 1px solid var(--border-light);
        border-radius: 20px;
        padding: 0.25rem 0.75rem;
        margin: 0 0.5rem;
      }
      .nav-url-container svg {
        width: 14px;
        height: 14px;
        stroke: var(--icon-secondary);
        margin-right: 0.5rem;
        flex-shrink: 0;
      }
      #nav-url-input {
        border: none;
        outline: none;
        flex: 1;
        font-size: 0.85rem;
        padding: 0.35rem 0;
        background: transparent;
        color: var(--text-color);
      }
      .nav-right {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        position: relative;
      }
      .dropdown-container {
        position: relative;
      }
      .dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--bg-color);
        border: 1px solid var(--border-light);
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow-dropdown);
        min-width: 150px;
        z-index: 1001;
        margin-top: 4px;
      }
      .dropdown-menu.show {
        display: block;
      }
      .dropdown-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--text-color);
        border-bottom: 1px solid var(--border-lighter);
        transition: background 0.2s;
      }
      .dropdown-item:last-child {
        border-bottom: none;
      }
      .dropdown-item:hover {
        background: var(--hover-bg);
      }
      .dropdown-item:first-child {
        border-radius: 8px 8px 0 0;
      }
      .dropdown-item:last-child {
        border-radius: 0 0 8px 8px;
      }
      .container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        transition: all 0.3s ease;
      }
      .container.iframe-active {
        padding: 0;
      }
      .home-content {
        text-align: center;
        max-width: 600px;
        width: 100%;
      }
      .logo {
        margin-bottom: 1rem;
      }
      .logo svg {
        width: 92px;
        height: 92px;
        stroke: var(--text-color);
        color: var(--text-color);
      }
      h1 {
        color: var(--text-color);
        font-size: 3rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
      }
      .subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
      }
      .search-container {
        background: var(--bg-color);
        border-radius: 50px;
        padding: 0.5rem 1.5rem;
        display: flex;
        align-items: center;
        box-shadow: 0 10px 40px var(--shadow-color);
        margin-bottom: 1rem;
        border: 2px solid var(--border-color);
      }
      .search-icon {
        margin-right: 1rem;
      }
      .search-icon svg {
        width: 24px;
        height: 24px;
        stroke: var(--text-color);
      }
      #url-input {
        border: none;
        outline: none;
        flex: 1;
        font-size: 1.1rem;
        padding: 0.75rem 0;
        background: transparent;
        color: var(--text-color);
      }

      .features {
        display: flex;
        gap: 2rem;
        margin-top: 3rem;
        justify-content: center;
        flex-wrap: wrap;
      }
      .feature {
        color: var(--text-color);
        text-align: center;
        opacity: 0.8;
      }
      .feature svg {
        width: 32px;
        height: 32px;
        stroke: var(--text-color);
        margin-bottom: 0.5rem;
      }
      .feature-text {
        font-size: 0.9rem;
      }
      #proxy-frame {
        display: none;
        width: 100%;
        height: calc(100vh - var(--nav-bar-height) - var(--tab-bar-height));
        border: none;
      }
      .iframe-active #proxy-frame {
        display: block;
      }
      .iframe-active .home-content {
        display: none;
      }
      /* Tab iframe styles */
      .tab-iframe {
        width: 100%;
        height: calc(100vh - var(--nav-bar-height) - var(--tab-bar-height));
        border: none;
        display: none;
      }
      .iframe-active .tab-iframe {
        /* Individual tab iframes control their own display */
      }
      .controls {
        position: fixed;
        top: 1rem;
        right: 1rem;
        display: none;
        gap: 0.5rem;
        z-index: 1000;
      }
      .iframe-active .controls {
        display: none;
      }
      .control-btn {
        background: var(--bg-color);
        border: 2px solid var(--border-color);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 10px var(--shadow-color);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
      }
      .control-btn:hover {
        transform: scale(1.1);
        background: var(--hover-bg);
      }
      .control-btn svg {
        width: 20px;
        height: 20px;
        stroke: var(--text-color);
      }
      .settings-btn {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: var(--bg-color);
        border: 2px solid var(--border-color);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 10px var(--shadow-color);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
        z-index: 1000;
        text-decoration: none;
      }
      .settings-btn:hover {
        transform: scale(1.1);
        background: var(--hover-bg);
      }
      .settings-btn svg {
        width: 20px;
        height: 20px;
        stroke: var(--text-color);
      }
      .settings-btn {
        display: none;
      }
      /* Default Proxy Selection Popup */
      .proxy-popup {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
        z-index: 2000;
        box-shadow: 0 -4px 20px var(--shadow-color);
        animation: slideUp 0.3s ease-out;
      }
      .proxy-popup.show {
        display: block;
      }
      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .proxy-popup-content {
        max-width: 600px;
        margin: 0 auto;
      }
      .proxy-popup h3 {
        color: var(--text-color);
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
      }
      .proxy-popup p {
        color: var(--text-secondary);
        margin: 0 0 1rem 0;
        font-size: 0.9rem;
      }
      .proxy-popup-options {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      .proxy-option-btn {
        flex: 1;
        min-width: 140px;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-color);
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
      }
      .proxy-option-btn:hover {
        background: var(--hover-bg);
        border-color: var(--text-color);
      }
      .proxy-option-btn strong {
        display: block;
        margin-bottom: 0.25rem;
      }
      .proxy-option-btn span {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }
      .proxy-popup-close {
        position: absolute;
        top: 0.75rem;
        right: 1rem;
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        color: var(--text-secondary);
        font-size: 1.25rem;
        line-height: 1;
      }
      .proxy-popup-close:hover {
        color: var(--text-color);
      }
    </style>
  </head>
  <body>
    <!-- Tab Bar -->
    <div class="tab-bar" id="tab-bar">
      <div class="tabs-container" id="tabs-container">
        <!-- Tabs will be dynamically added here -->
        <button class="tab-add-btn" id="tab-add-btn" title="New Tab" onclick="addNewTab()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M12 5l0 14"/>
            <path d="M5 12l14 0"/>
          </svg>
        </button>
      </div>
    </div>
    <!-- Upper Navigation Bar -->
    <nav class="upper-nav">
      <div class="nav-left">
        <!-- Back Button -->
        <button class="nav-btn" id="nav-back" title="Go Back" onclick="navGoBack()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M5 12l14 0"/>
            <path d="M5 12l6 6"/>
            <path d="M5 12l6 -6"/>
          </svg>
        </button>
        <!-- Forward Button -->
        <button class="nav-btn" id="nav-forward" title="Go Forward" onclick="navGoForward()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M5 12l14 0"/>
            <path d="M13 18l6 -6"/>
            <path d="M13 6l6 6"/>
          </svg>
        </button>
        <!-- Reload Button -->
        <button class="nav-btn" id="nav-reload" title="Reload" onclick="navReload()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/>
            <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/>
          </svg>
        </button>
        <!-- Home Button -->
        <button class="nav-btn" id="nav-home" title="Home" onclick="goHome()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M5 12l-2 0l9 -9l9 9l-2 0"/>
            <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"/>
            <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"/>
          </svg>
        </button>
      </div>
      <!-- URL Bar -->
      <div class="nav-url-container">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/>
          <path d="M21 21l-6 -6"/>
        </svg>
        <input type="text" id="nav-url-input" placeholder="Search or enter URL..." />
      </div>
      <div class="nav-right">
        <!-- Settings Button -->
        <button class="nav-btn" id="nav-settings" title="Settings" onclick="goToSettings()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z"/>
            <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/>
          </svg>
        </button>
        <!-- Dropdown Menu -->
        <div class="dropdown-container">
          <button class="nav-btn" id="nav-menu" title="More options" onclick="toggleDropdown()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/>
              <path d="M12 5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/>
              <path d="M12 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/>
            </svg>
          </button>
          <div class="dropdown-menu" id="dropdown-menu">
            <div class="dropdown-item" onclick="goToSettings()">Settings</div>
            <div class="dropdown-item" onclick="goHome()">Home</div>
          </div>
        </div>
      </div>
    </nav>
    <a href="/settings.html" class="settings-btn" title="Settings">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="icon icon-tabler icon-tabler-settings"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        stroke-width="2"
        fill="none"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z" />
        <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
      </svg>
    </a>
    <div class="container" id="container">
      <div class="home-content">
        <div class="logo">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="92"
            height="92"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M12 3a12 12 0 0 0 8.5 3a12 12 0 0 1 -8.5 15a12 12 0 0 1 -8.5 -15a12 12 0 0 0 8.5 -3" />
            <path d="M12 3v18" />
            <path d="M12 11l0 .01" />
            <path d="M12 14l0 .01" />
          </svg>
        </div>
        <h1>Nova</h1>
        <p class="subtitle">Fast and secure web proxy</p>

        <div class="search-container">
          <div class="search-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="icon icon-tabler icon-tabler-search"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke-width="2"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
              <path d="M21 21l-6 -6" />
            </svg>
          </div>
          <input
            type="text"
            id="url-input"
            placeholder="Search or enter URL..."
          />
        </div>
        <div class="features">
          <div class="feature">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="icon icon-tabler icon-tabler-bolt"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke-width="2"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M13 3l0 7l6 0l-8 11l0 -7l-6 0l8 -11" />
            </svg>
            <div class="feature-text">Fast</div>
          </div>
          <div class="feature">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="icon icon-tabler icon-tabler-lock"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke-width="2"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path
                d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z"
              />
              <path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0" />
              <path d="M8 11v-4a4 4 0 1 1 8 0v4" />
            </svg>
            <div class="feature-text">Secure</div>
          </div>
          <div class="feature">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="icon icon-tabler icon-tabler-eye-off"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke-width="2"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M10.585 10.587a2 2 0 0 0 2.829 2.828" />
              <path
                d="M16.681 16.673a8.717 8.717 0 0 1 -4.681 1.327c-3.6 0 -6.6 -2 -9 -6c1.272 -2.12 2.712 -3.678 4.32 -4.674m2.86 -1.146a9.055 9.055 0 0 1 1.82 -.18c3.6 0 6.6 2 9 6c-.666 1.11 -1.379 2.067 -2.138 2.87"
              />
              <path d="M3 3l18 18" />
            </svg>
            <div class="feature-text">Private</div>
          </div>
        </div>
      </div>
      <iframe id="proxy-frame"></iframe>
      <div class="controls">
        <button class="control-btn" onclick="goHome()" title="Home">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="icon icon-tabler icon-tabler-home"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M5 12l-2 0l9 -9l9 9l-2 0" />
            <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
            <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
          </svg>
        </button>
      </div>
    </div>
    <!-- Default Proxy Selection Popup -->
    <div class="proxy-popup" id="proxy-popup">
      <button class="proxy-popup-close" onclick="closeProxyPopup()" title="Close">&times;</button>
      <div class="proxy-popup-content">
        <h3>Choose Your Default Proxy Engine</h3>
        <p>Select which proxy engine to use by default. You can change this later in Settings.</p>
        <div class="proxy-popup-options">
          <button class="proxy-option-btn" onclick="selectDefaultProxy('scramjet')">
            <strong>Scramjet</strong>
            <span>Modern &amp; fast (recommended)</span>
          </button>
          <button class="proxy-option-btn" onclick="selectDefaultProxy('ultraviolet')">
            <strong>Ultraviolet</strong>
            <span>Classic &amp; compatible</span>
          </button>
        </div>
      </div>
    </div>
    <!-- Client script handles all proxy logic -->
    <script src="/client.js"></script>
    <script>
      // Allow Enter key to submit on main URL input
      document
        .getElementById("url-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            loadUrl();
          }
        });

      // Navigation bar URL input - select all text on click
      const navUrlInput = document.getElementById("nav-url-input");
      navUrlInput.addEventListener("click", function () {
        this.select();
      });

      // Allow Enter key to submit on nav URL input
      navUrlInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          loadNavUrl();
        }
      });

      // Toggle dropdown menu
      function toggleDropdown() {
        const dropdown = document.getElementById("dropdown-menu");
        dropdown.classList.toggle("show");
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        const dropdown = document.getElementById("dropdown-menu");
        const menuBtn = document.getElementById("nav-menu");
        if (!dropdown.contains(e.target) && !menuBtn.contains(e.target)) {
          dropdown.classList.remove("show");
        }
      });

      // Navigation functions
      function getActiveTabIframe() {
        // Get the active tab's iframe
        if (typeof getActiveTabId === "function" && typeof getTabById === "function") {
          const tabId = getActiveTabId();
          const tab = getTabById(tabId);
          if (tab && tab.iframeId) {
            return document.getElementById(tab.iframeId);
          }
        }
        // Fallback to proxy-frame
        return document.getElementById("proxy-frame");
      }
      
      function navGoBack() {
        const iframe = getActiveTabIframe();
        if (iframe && iframe.contentWindow) {
          try {
            iframe.contentWindow.history.back();
          } catch (e) {
            console.log("Cannot navigate back:", e);
          }
        }
      }

      function navGoForward() {
        const iframe = getActiveTabIframe();
        if (iframe && iframe.contentWindow) {
          try {
            iframe.contentWindow.history.forward();
          } catch (e) {
            console.log("Cannot navigate forward:", e);
          }
        }
      }

      function navReload() {
        const iframe = getActiveTabIframe();
        if (iframe && iframe.contentWindow) {
          try {
            iframe.contentWindow.location.reload();
          } catch (e) {
            console.log("Cannot reload:", e);
          }
        }
      }

      // Helper function to get or create the proxy iframe
      function getOrCreateProxyIframe() {
        const container = document.getElementById("container");
        container.classList.add("iframe-active");
        let iframe = document.getElementById("proxy-frame");
        if (!iframe) {
          iframe = document.createElement("iframe");
          iframe.id = "proxy-frame";
          // CSS handles styling via #proxy-frame selector
          container.appendChild(iframe);
        }
        return iframe;
      }

      function goToSettings() {
        const dropdown = document.getElementById("dropdown-menu");
        dropdown.classList.remove("show");
        // Use tab system if available
        if (typeof getActiveTabId === "function") {
          // This will be overridden by the tab system
        } else {
          // Fallback: Navigate to settings page directly
          window.location.href = "/settings.html";
        }
      }

      // Load URL from navigation bar
      function loadNavUrl() {
        const input = navUrlInput.value.trim().toLowerCase();
        
        // Handle nova: special URLs
        if (input === "nova:home") {
          goHome();
          return;
        }
        if (input === "nova:settings") {
          goToSettings();
          return;
        }
        if (input === "nova:error") {
          navUrlInput.value = "nova:error";
          const iframe = getOrCreateProxyIframe();
          iframe.src = "/error.html";
          iframe.style.display = "block";
          return;
        }
        
        // Regular URL handling
        const urlInput = document.getElementById("url-input");
        urlInput.value = navUrlInput.value.trim();
        loadUrl();
      }

      // Update nav URL bar when navigating (called from client.js)
      window.updateNavUrlBar = function(url) {
        navUrlInput.value = url || "";
      };

      // Theme management
      const THEME_KEY = 'nova-theme';
      
      function applyTheme() {
        const theme = localStorage.getItem(THEME_KEY) || 'system';
        
        if (theme === 'dark') {
          document.body.classList.add('dark');
        } else if (theme === 'light') {
          document.body.classList.remove('dark');
        } else {
          // System theme - check if system prefers dark
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark');
          } else {
            document.body.classList.remove('dark');
          }
        }
      }
      
      // Apply theme on load
      applyTheme();
      
      // Listen for system theme changes
      if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
          const currentTheme = localStorage.getItem(THEME_KEY) || 'system';
          if (currentTheme === 'system') {
            applyTheme();
          }
        });
      }

      // Default Proxy Selection Popup
      const PROXY_POPUP_SHOWN_KEY = 'nova-proxy-popup-shown';
      
      function showProxyPopup() {
        const popup = document.getElementById('proxy-popup');
        if (popup) {
          popup.classList.add('show');
        }
      }
      
      function closeProxyPopup() {
        const popup = document.getElementById('proxy-popup');
        if (popup) {
          popup.classList.remove('show');
        }
        // Mark as shown so it doesn't appear again
        localStorage.setItem(PROXY_POPUP_SHOWN_KEY, 'true');
      }
      
      function selectDefaultProxy(engine) {
        // Save the selection
        localStorage.setItem('nova-proxy-engine', engine);
        // Close the popup
        closeProxyPopup();
      }
      
      // Show popup on first visit (after a short delay for better UX)
      if (!localStorage.getItem(PROXY_POPUP_SHOWN_KEY)) {
        setTimeout(showProxyPopup, 500);
      }

      // ==========================================
      // TAB MANAGEMENT SYSTEM
      // ==========================================
      
      // Tab data structure - exposed on window for cross-frame access (same-origin only)
      // Note: This is intentionally exposed for communication with same-origin iframes
      // like settings.html. Cross-origin iframes cannot access these properties.
      const tabs = [];
      window.tabs = tabs;
      let activeTabId = null;
      Object.defineProperty(window, 'activeTabId', {
        get: () => activeTabId,
        set: (val) => { activeTabId = val; }
      });
      let tabIdCounter = 0;
      let draggedTab = null;
      
      // Nova icon SVG for home/settings pages
      const NOVA_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M12 3a12 12 0 0 0 8.5 3a12 12 0 0 1 -8.5 15a12 12 0 0 1 -8.5 -15a12 12 0 0 0 8.5 -3"/>
        <path d="M12 3v18"/>
        <path d="M12 11l0 .01"/>
        <path d="M12 14l0 .01"/>
      </svg>`;
      
      // Close icon SVG
      const CLOSE_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M18 6l-12 12"/>
        <path d="M6 6l12 12"/>
      </svg>`;
      
      // Create a new tab object
      function createTabData(type, url, title) {
        return {
          id: tabIdCounter++,
          type: type, // 'home', 'settings', 'proxy'
          url: url || '',
          title: title || 'New Tab',
          favicon: null,
          iframeId: null
        };
      }
      
      // Get display title for tab
      function getTabTitle(tab) {
        if (tab.type === 'home') return 'New Tab';
        if (tab.type === 'settings') return 'Settings';
        if (tab.title) return tab.title;
        if (tab.url) {
          try {
            return new URL(tab.url).hostname;
          } catch (e) {
            return tab.url;
          }
        }
        return 'New Tab';
      }
      
      // Sanitize URL for safe use (allow http/https protocols and local proxy paths)
      function sanitizeUrl(url) {
        if (!url) return null;
        try {
          const urlObj = new URL(url, location.origin);
          // Allow http/https protocols
          if (urlObj.protocol === 'http:' || urlObj.protocol === 'https:') {
            // For local proxy paths (same origin), allow them
            if (urlObj.origin === location.origin) {
              // Verify it's a valid proxy path (scramjet uses /scramjet/, /scram/, UV uses /service/)
              if (urlObj.pathname.startsWith('/scramjet/') || urlObj.pathname.startsWith('/scram/') || urlObj.pathname.startsWith('/service/')) {
                return urlObj.href;
              }
            }
            // For external URLs, also allow (browser will handle CORS)
            return urlObj.href;
          }
        } catch (e) {
          // Invalid URL - check if it's a relative proxy path
          if (typeof url === 'string' && (url.startsWith('/scramjet/') || url.startsWith('/scram/') || url.startsWith('/service/'))) {
            return url;
          }
        }
        return null;
      }
      
      // Create favicon element for tab (returns DOM element or HTML string)
      function createFaviconElement(tab, useHtml) {
        if (tab.type === 'home' || tab.type === 'settings') {
          if (useHtml) return NOVA_ICON_SVG;
          const div = document.createElement('div');
          div.innerHTML = NOVA_ICON_SVG;
          return div.firstElementChild;
        }
        const safeFavicon = sanitizeUrl(tab.favicon);
        if (safeFavicon) {
          if (useHtml) {
            // For HTML string, we need to escape properly
            const escapedUrl = safeFavicon
              .replace(/&/g, '&amp;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#39;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;');
            return `<img src="${escapedUrl}" alt="" />`;
          }
          const img = document.createElement('img');
          img.src = safeFavicon;
          img.alt = '';
          img.onerror = function() {
            this.parentElement.innerHTML = NOVA_ICON_SVG;
          };
          return img;
        }
        // Default to Nova icon if no favicon
        if (useHtml) return NOVA_ICON_SVG;
        const div = document.createElement('div');
        div.innerHTML = NOVA_ICON_SVG;
        return div.firstElementChild;
      }
      
      // Get favicon HTML for tab (legacy compatibility)
      function getTabFaviconHtml(tab) {
        return createFaviconElement(tab, true);
      }
      
      // Create tab DOM element
      function createTabElement(tab) {
        const tabEl = document.createElement('div');
        tabEl.className = 'tab';
        tabEl.dataset.tabId = tab.id;
        tabEl.draggable = true;
        
        // Create favicon container
        const faviconDiv = document.createElement('div');
        faviconDiv.className = 'tab-favicon';
        const faviconEl = createFaviconElement(tab, false);
        if (faviconEl) {
          faviconDiv.appendChild(faviconEl);
          // Add onerror handler for image elements
          if (faviconEl.tagName === 'IMG') {
            faviconEl.onerror = function() {
              this.parentElement.innerHTML = NOVA_ICON_SVG;
            };
          }
        }
        
        // Create title span
        const titleSpan = document.createElement('span');
        titleSpan.className = 'tab-title';
        titleSpan.textContent = getTabTitle(tab);
        
        // Create close button
        const closeBtn = document.createElement('button');
        closeBtn.className = 'tab-close';
        closeBtn.title = 'Close tab';
        closeBtn.innerHTML = CLOSE_ICON_SVG;
        
        tabEl.appendChild(faviconDiv);
        tabEl.appendChild(titleSpan);
        tabEl.appendChild(closeBtn);
        
        // Click to switch tab
        tabEl.addEventListener('click', (e) => {
          if (!e.target.closest('.tab-close')) {
            switchToTab(tab.id);
          }
        });
        
        // Close button
        tabEl.querySelector('.tab-close').addEventListener('click', (e) => {
          e.stopPropagation();
          closeTab(tab.id);
        });
        
        // Drag events
        tabEl.addEventListener('dragstart', (e) => {
          draggedTab = tabEl;
          tabEl.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });
        
        tabEl.addEventListener('dragend', () => {
          tabEl.classList.remove('dragging');
          draggedTab = null;
        });
        
        tabEl.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });
        
        tabEl.addEventListener('drop', (e) => {
          e.preventDefault();
          if (draggedTab && draggedTab !== tabEl) {
            const container = document.getElementById('tabs-container');
            const tabEls = Array.from(container.querySelectorAll('.tab'));
            const draggedIndex = tabEls.indexOf(draggedTab);
            const dropIndex = tabEls.indexOf(tabEl);
            
            // Reorder in DOM
            if (draggedIndex < dropIndex) {
              tabEl.after(draggedTab);
            } else {
              tabEl.before(draggedTab);
            }
            
            // Reorder in tabs array - adjust dropIndex when moving forward
            const draggedTabData = tabs.splice(draggedIndex, 1)[0];
            const adjustedDropIndex = draggedIndex < dropIndex ? dropIndex - 1 : dropIndex;
            tabs.splice(adjustedDropIndex, 0, draggedTabData);
            
            saveTabsToStorage();
          }
        });
        
        return tabEl;
      }
      
      // Render all tabs
      function renderTabs() {
        const container = document.getElementById('tabs-container');
        const addBtn = document.getElementById('tab-add-btn');
        
        // Safety check: ensure required elements exist
        if (!container) return;
        
        // Remove all tabs but keep the add button
        const existingTabs = container.querySelectorAll('.tab');
        existingTabs.forEach(tab => tab.remove());
        
        tabs.forEach(tab => {
          const tabEl = createTabElement(tab);
          if (tab.id === activeTabId) {
            tabEl.classList.add('active');
          }
          // Insert before the add button (or append at end if button not found)
          if (addBtn && addBtn.parentNode === container) {
            container.insertBefore(tabEl, addBtn);
          } else {
            container.appendChild(tabEl);
          }
        });
        
        // Ensure the add button is at the end of the container
        if (addBtn && (addBtn.parentNode !== container || container.lastElementChild !== addBtn)) {
          container.appendChild(addBtn);
        }
        
        adjustTabSizes();
      }
      
      // Adjust tab sizes based on available space
      function adjustTabSizes() {
        const container = document.getElementById('tabs-container');
        const tabBar = document.getElementById('tab-bar');
        const addBtn = document.getElementById('tab-add-btn');
        const tabEls = container.querySelectorAll('.tab');
        
        // Early return if required elements are missing
        if (!container || !tabBar || !addBtn || tabEls.length === 0) return;
        
        // Reset all tabs to default state
        tabEls.forEach(tab => {
          tab.classList.remove('compact', 'medium');
        });
        
        // Get available width
        const availableWidth = tabBar.clientWidth - addBtn.offsetWidth - 24; // 24px for padding
        const tabCount = tabEls.length;
        const maxTabWidth = 200;
        const mediumTabWidth = 80;
        const compactTabWidth = 50; // Updated for favicon + close button
        
        // Calculate ideal width per tab
        const idealWidth = availableWidth / tabCount;
        
        if (idealWidth >= maxTabWidth) {
          // Full size tabs - no change needed
        } else if (idealWidth >= mediumTabWidth) {
          // Medium size - show favicon and close button
          tabEls.forEach(tab => tab.classList.add('medium'));
        } else if (idealWidth >= compactTabWidth) {
          // Compact - favicon and close button
          tabEls.forEach(tab => tab.classList.add('compact'));
        } else {
          // At minimum, still show compact and let scrollbar appear
          tabEls.forEach(tab => tab.classList.add('compact'));
        }
      }
      
      // Switch to a specific tab
      function switchToTab(tabId) {
        const tab = tabs.find(t => t.id === tabId);
        if (!tab) return;
        
        activeTabId = tabId;
        
        // Update active class
        document.querySelectorAll('.tab').forEach(el => {
          el.classList.toggle('active', parseInt(el.dataset.tabId) === tabId);
        });
        
        const container = document.getElementById('container');
        
        // Handle different tab types
        if (tab.type === 'home') {
          // Show home content
          container.classList.remove('iframe-active');
          hideAllIframes();
          navUrlInput.value = '';
          document.getElementById('url-input').value = '';
        } else if (tab.type === 'settings') {
          // Settings is on a separate page, so navigate there
          // But we want to keep tabs, so we'll load settings in an iframe
          container.classList.add('iframe-active');
          hideAllIframes();
          showOrCreateTabIframe(tab, '/settings.html');
          navUrlInput.value = 'nova:settings';
        } else if (tab.type === 'proxy') {
          // Show proxy content
          container.classList.add('iframe-active');
          hideAllIframes();
          showOrCreateTabIframe(tab);
          navUrlInput.value = tab.url || '';
        }
        
        saveTabsToStorage();
      }
      
      // Hide all iframes
      function hideAllIframes() {
        document.querySelectorAll('#container iframe').forEach(iframe => {
          iframe.style.display = 'none';
        });
      }
      
      // Show or create iframe for tab
      function showOrCreateTabIframe(tab, overrideUrl) {
        const container = document.getElementById('container');
        let iframe = null;
        let isNewIframe = false;
        
        if (tab.iframeId) {
          iframe = document.getElementById(tab.iframeId);
        }
        
        if (!iframe) {
          isNewIframe = true;
          iframe = document.createElement('iframe');
          tab.iframeId = 'tab-iframe-' + tab.id;
          iframe.id = tab.iframeId;
          iframe.className = 'tab-iframe';
          iframe.style.width = '100%';
          iframe.style.height = 'calc(100vh - var(--nav-bar-height) - var(--tab-bar-height))';
          iframe.style.border = 'none';
          
          // Remove old proxy-frame if exists
          const oldFrame = document.getElementById('proxy-frame');
          if (oldFrame) oldFrame.remove();
          
          container.appendChild(iframe);
        }
        
        // Load URL - always update src when overrideUrl is provided
        if (overrideUrl) {
          iframe.src = overrideUrl;
        } else if (isNewIframe && tab.url && window.loadUrlInTab) {
          // Use the proxy loader from client.js for new iframes
          window.loadUrlInTab(tab.id, tab.url);
        }
        
        iframe.style.display = 'block';
        
        // Update CSS for iframe-active state
        container.classList.add('iframe-active');
      }
      
      // Add a new tab
      function addNewTab() {
        const tab = createTabData('home', '', 'New Tab');
        tabs.push(tab);
        renderTabs();
        switchToTab(tab.id);
        saveTabsToStorage();
      }
      
      // Close a tab
      function closeTab(tabId) {
        const tabIndex = tabs.findIndex(t => t.id === tabId);
        if (tabIndex === -1) return;
        
        const tab = tabs[tabIndex];
        
        // Remove iframe if exists
        if (tab.iframeId) {
          const iframe = document.getElementById(tab.iframeId);
          if (iframe) iframe.remove();
        }
        
        // Remove from array
        tabs.splice(tabIndex, 1);
        
        // If this was the active tab, switch to another
        if (tabId === activeTabId) {
          if (tabs.length > 0) {
            // Switch to the tab at the same position or the last one
            const newIndex = Math.min(tabIndex, tabs.length - 1);
            activeTabId = tabs[newIndex].id;
            switchToTab(activeTabId);
          } else {
            // No tabs left, create a new one
            addNewTab();
            return;
          }
        }
        
        renderTabs();
        saveTabsToStorage();
      }
      
      // Update tab info (called from client.js)
      window.updateTabInfo = function(tabId, info) {
        const tab = tabs.find(t => t.id === tabId);
        if (!tab) return;
        
        if (info.url !== undefined) tab.url = info.url;
        if (info.title !== undefined) tab.title = info.title;
        if (info.favicon !== undefined) tab.favicon = info.favicon;
        
        // Update DOM - find tab element safely by iterating
        const container = document.getElementById('tabs-container');
        if (!container) return;
        const tabEls = container.querySelectorAll('.tab');
        let tabEl = null;
        for (const el of tabEls) {
          if (parseInt(el.dataset.tabId, 10) === tabId) {
            tabEl = el;
            break;
          }
        }
        if (tabEl) {
          const titleEl = tabEl.querySelector('.tab-title');
          if (titleEl) {
            titleEl.textContent = getTabTitle(tab);
          }
          
          // Update favicon - use DOM element creation to properly attach onerror handler
          const faviconContainer = tabEl.querySelector('.tab-favicon');
          if (faviconContainer) {
            faviconContainer.innerHTML = '';
            const faviconEl = createFaviconElement(tab, false);
            if (faviconEl) {
              faviconContainer.appendChild(faviconEl);
            }
          }
        }
        
        // Update nav URL bar if this is the active tab
        if (tabId === activeTabId && info.url !== undefined) {
          navUrlInput.value = info.url;
        }
        
        saveTabsToStorage();
      };
      
      // Get active tab ID
      window.getActiveTabId = function() {
        return activeTabId;
      };
      
      // Get tab by ID
      window.getTabById = function(tabId) {
        return tabs.find(t => t.id === tabId);
      };
      
      // Load URL in active tab (replaces goHome behavior for proxy)
      window.loadUrlInActiveTab = function(url) {
        const tab = tabs.find(t => t.id === activeTabId);
        if (!tab) return;
        
        tab.type = 'proxy';
        tab.url = url;
        tab.title = '';
        tab.favicon = null;
        
        const container = document.getElementById('container');
        container.classList.add('iframe-active');
        hideAllIframes();
        
        // The actual proxy loading is handled by client.js
        // We just need to prepare the tab state
      };
      
      // Open a URL in a new tab (used by window.open interception)
      // Returns the new tab ID for tracking
      window.openUrlInNewTab = function(url) {
        // If no URL or empty URL, create a home tab
        if (!url) {
          const tab = createTabData('home', '', 'New Tab');
          tabs.push(tab);
          renderTabs();
          switchToTab(tab.id);
          saveTabsToStorage();
          return tab.id;
        }
        
        // Create a new proxy tab with the URL
        const tab = createTabData('proxy', url, '');
        tabs.push(tab);
        renderTabs();
        switchToTab(tab.id);
        saveTabsToStorage();
        
        // Load the URL in the new tab
        if (window.loadUrlInTab) {
          window.loadUrlInTab(tab.id, url);
        }
        
        return tab.id;
      };
      
      // Storage functions
      function saveTabsToStorage() {
        const data = {
          tabs: tabs.map(t => ({
            id: t.id,
            type: t.type,
            url: t.url,
            title: t.title,
            favicon: t.favicon
          })),
          activeTabId: activeTabId,
          tabIdCounter: tabIdCounter
        };
        localStorage.setItem('nova-tabs', JSON.stringify(data));
      }
      
      function loadTabsFromStorage() {
        try {
          const data = JSON.parse(localStorage.getItem('nova-tabs'));
          if (data && data.tabs && data.tabs.length > 0) {
            tabs.length = 0;
            data.tabs.forEach(t => tabs.push({
              ...t,
              iframeId: null // Reset iframe IDs on reload
            }));
            tabIdCounter = data.tabIdCounter || tabs.length;
            activeTabId = data.activeTabId;
            return true;
          }
        } catch (e) {
          console.error('Failed to load tabs from storage:', e);
        }
        return false;
      }
      
      // Override goToSettings to open in current tab
      goToSettings = function() {
        const dropdown = document.getElementById("dropdown-menu");
        dropdown.classList.remove("show");
        
        const tab = tabs.find(t => t.id === activeTabId);
        if (tab) {
          tab.type = 'settings';
          tab.url = '';
          tab.title = 'Settings';
          tab.favicon = null;
          renderTabs();
          switchToTab(activeTabId);
        }
      };
      
      // Override goHome to go to home in current tab
      const originalGoHome = window.goHome;
      window.goHome = function() {
        // Use window.tabs and window.activeTabId for cross-frame compatibility
        const tab = window.tabs.find(t => t.id === window.activeTabId);
        if (tab) {
          tab.type = 'home';
          tab.url = '';
          tab.title = 'New Tab';
          tab.favicon = null;
          
          // Clear iframe
          if (tab.iframeId) {
            const iframe = document.getElementById(tab.iframeId);
            if (iframe) iframe.remove();
            tab.iframeId = null;
          }
          
          renderTabs();
          switchToTab(window.activeTabId);
        }
      };
      
      // Reload with settings - saves tab state and reloads page to apply new settings
      window.reloadWithSettings = function() {
        // Save current tab state before reload
        saveTabsToStorage();
        
        // Reload the page to apply new settings
        // The tab state will be restored from localStorage on reload
        window.location.reload();
      };
      
      // Initialize tabs on page load
      function initTabs() {
        if (!loadTabsFromStorage()) {
          // Create initial home tab
          const homeTab = createTabData('home', '', 'New Tab');
          tabs.push(homeTab);
          activeTabId = homeTab.id;
        }
        
        renderTabs();
        
        // Ensure we switch to the active tab to restore state
        if (activeTabId !== null) {
          switchToTab(activeTabId);
        }
      }
      
      // Handle window resize for tab sizing
      window.addEventListener('resize', adjustTabSizes);
      
      // Initialize tabs after DOM is ready
      initTabs();
    </script>
  </body>
</html>
